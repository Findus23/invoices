\documentclass[
        a4paper,
        12pt,
        version=last,
        fromalign=right,
%       foldmarks=p, % keine mittlere Faltmarke
        foldmarks=off,
        enlargefirstpage,
        fromemail,
        fromphone,
%       fromcity,
        fromlogo,
        fromrule,
        backaddress,
]{scrlttr2}
\usepackage[utf8]{inputenc}
\BLOCK{ if details.locale == "de" }
\usepackage[ngerman]{babel}
\BLOCK{ else }
\usepackage[english]{babel}
\BLOCK{ endif }
\usepackage[T1]{fontenc}
\usepackage{lmodern}
\usepackage{mathpazo}
\usepackage[left]{eurosym}
\usepackage{booktabs}
\usepackage{microtype}
\usepackage{tabularx}

\usepackage{color}
\definecolor{LightGray}{rgb}{0.7,0.7,0.7}
\definecolor{Gray}{rgb}{0.5,0.5,0.5}
\setkomafont{fromrule}{\color{LightGray}}
\setkomafont{fromaddress}{\sffamily} % Sans Serif
\setkomafont{fromname}{\sffamily\bfseries} % and bold
\setkomafont{pagefoot}{\sffamily\bfseries}

\usepackage{graphicx}

\newcommand{\separ}{~\textperiodcentered~}

\hyphenpenalty=10000

\newcommand{\VAR}[1]{\LaTeX} % Just a placeholder (will never be used)

\newcommand{\BLOCK}[1]{\LaTeX} % Just a placeholder (will never be used)

\newcommand{\Name}{\VAR{user.name}}
\setkomavar{fromname}{\Name}
\newcommand{\Address}{\VAR{user.address}}
\newcommand{\ZIP}{\VAR{user.zip}}
\newcommand{\City}{\VAR{user.city}}
\newcommand{\Country}{\VAR{user.country}}

\setkomavar{fromaddress}{\Address\\\ZIP~\City\\\Country}
\setkomavar{fromphone}[]{\VAR{user.phone}}
\setkomavar{fromemail}[]{\VAR{user.email}}
\setkomavar{fromurl}[]{\VAR{user.url}}
%\setkomavar{fromlogo}{\includegraphics[height=3.2cm]{template/header.jpg}}


\setkomavar{frombank}{\VAR{user.bank}\separ IBAN: \VAR{user.IBAN}\separ BIC: \VAR{user.BIC}}
%TODO: Linie Ã¼ber
\setkomavar{firstfoot}{
    \centering
    \color{Gray}\scriptsize
    \begin{tabular}[t]{c@{}}
    \Name\separ\Address\separ\ZIP~\City\\
    \BLOCK{ if user.ustid }
    \VAR{"ustid"|t}: \VAR{user.ustid} \\
    \BLOCK{ elif user.stid }
    \VAR{"stid"|t}: \VAR{user.stid} \\
    \BLOCK{ endif }
    \usekomavar{fromphone}\separ\usekomavar{fromemail}\separ\usekomavar{fromurl}\\\usekomavar{frombank} \\
    \end{tabular}
    }
% \setkomavar{nextfoot}{\usekomavar{firstfoot}}
% from: https://tex.stackexchange.com/questions/426016/nexthead-and-nextfoot-problem-in-multi-page-letter-with-koma-and-srclttr2
\usepackage{scrlayer-scrpage}% <- sets pagestyle scrheadings automatically
\DeclareNewLayer[
  foreground,
  textarea,
  voffset=\useplength{firstfootvpos},
  hoffset=\dimexpr.5\paperwidth-.36\useplength{firstfootwidth}\relax,
  width=\useplength{firstfootwidth},
  mode=picture,
  contents=\putUL{\raisebox{\dimexpr-\height}{\centering\usekomavar{firstfoot}}}
]{likefirstpage.foot}

\AddLayersToPageStyle{scrheadings}{likefirstpage.foot}
\clearpairofpagestyles
\chead*{\pagemark}


\setkomavar{invoice}{\VAR{details.invoice_id}}
\setkomavar{date}{\VAR{datestr}}
\newkomavar*[\VAR{"timeframe"|t}]{timeframe}
\setkomavar{timeframe}{\VAR{details.timeframe}}


\pdfinfo{
   /Author (\Name)
   /Title  (\VAR{"invoice" |t} \VAR{user.name} \VAR{datestr})
   /Subject (\VAR{"invoice" |t} \VAR{user.name} \VAR{datestr})
   /Keywords (\VAR{"invoice" |t} \VAR{datestr})
}

\setkomavar{backaddress}{\usekomavar{fromname}, \Address, \ZIP~\City}

% Begin document
\begin{document}
\begin{letter}{\VAR{client.name} \\ \VAR{client.address} \\ \VAR{client.zip}~\VAR{client.city}\\\VAR{client.country}}
\setkomavar{title}{\VAR{details.title}}
\opening{}

% details.mode=="single"
% \begin{tabularx}{\textwidth}{lX}
%       \VA R{"descr"|t}:  & \VA R{details.description} \\
%       \VA R{"period"|t}: & \VA R{details.timeframe} \\
%       \VA R{"total"|t}:  & \EUR{\VA R{details.price | formatdigit }} \\
%
%       \vspace{0.5cm}
%
% \end{tabularx}

% Consider a table with:
% Amount | Unit | description ('Leistung') | price per unit | total

\vspace{0.5cm}
\begin{tabularx}{\textwidth}{Xrrr}
    \VAR{"descr"|t} & \VAR{"amount"|t} & \VAR{"item_price"|t} & \VAR{"total"|t} \\ \midrule

    \BLOCK{ if items_table }
        \VAR{items_table}
    \BLOCK{ else }
        \VAR{details.description} &
        \VAR{details.hours_worked} &
        \VAR{details.hourly_rate_cents | formatdigit } \EUR &
        \VAR{total_cost | formatdigit } \EUR \\
    \BLOCK{ endif }

    \midrule %\cmidrule{4-4}

    \BLOCK{ if details.mwst_percent }

        \vspace{0.5cm} \\

        \VAR{"net"|t} & & & \VAR{total_cost | formatdigit} \EUR \\
        \VAR{"plus"|t} \VAR{details.mwst_percent} \% MwSt. & & & \VAR{(total_cost * details.mwst_percent / 100) | formatdigit} \EUR \\
        \VAR{"total"|t} & & & \VAR{(total_cost + total_cost * details.mwst_percent / 100) | formatdigit} \EUR \\

        \midrule

    \BLOCK{ else }
        & & & \VAR{total_cost | formatdigit } \EUR \\
    \BLOCK{ endif }

\end{tabularx}


\vspace{1cm}
\noindent \VAR{"transfer"|t}:

\vspace{0.5cm}

\begin{tabular}{@{}ll}
        Bank: &\VAR{user.bank}\\
        IBAN:& \VAR{user.IBAN}\\
        BIC:& \VAR{user.BIC}
\end{tabular}


\end{letter}
\end{document}
